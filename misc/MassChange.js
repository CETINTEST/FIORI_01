/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","ui/s2p/mm/requisition/maintain/s1/misc/EntityConstants","ui/s2p/mm/requisition/maintain/s1/misc/URLGenerators","ui/s2p/mm/requisition/maintain/s1/misc/DataAccess","ui/s2p/mm/requisition/maintain/s1/misc/DataManager","sap/ui/model/Filter"],function(O,E,U,D,a,F){"use strict";var A=O.extend("ui.s2p.mm.requisition.maintain.s1.misc.MassChange");A.onPressApplyChangeMass=function(P){var d="ui.s2p.mm.requisition.maintain.s1.view.MassChange";if(!P.dialog){P.dialog=sap.ui.xmlfragment(d,P);P.getView().addDependent(P.dialog);}this.dialog=P.dialog;this.oModelItemDetails=A.createItemModel(P);this.oParentController=P;A.setCountryTexts(P);};A.setCountryTexts=function(P){var o=P.getView().byId("smartForm1").getBindingContext().getObject();var s='/I_CountryText';var m=P.getAppModel();if(o.Language==''){o.Language='EN';}m.read(s,{urlParameters:{"$filter":"Country eq '"+o.AddressCountry+"'"+"  and Language eq '"+o.Language+"'"},success:jQuery.proxy(A.textReadSuccess,this),error:jQuery.proxy(A.textReadFailure,this)});};A.textReadSuccess=function(d){if(d.results.length){var c=d.results[0];var b=c.CountryName;this.oModelItemDetails.getData().countryName=b;}A.setRegionTexts(this.oParentController);};A.textReadFailure=function(){A.setRegionTexts(this.oParentController);};A.setRegionTexts=function(P){var o=P.getView().byId("smartForm1").getBindingContext().getObject();var s='/I_Region';var m=P.getAppModel();m.read(s,{urlParameters:{"$filter":"Region eq '"+o.AddressRegion+"'"+"  and Country eq '"+o.AddressCountry+"'"},success:jQuery.proxy(A.textRegionReadSuccess,this),error:jQuery.proxy(A.textRegionReadFailure,this)});};A.textRegionReadSuccess=function(d){if(d.results.length){var r=d.results[0];var b=r.Region_Text;this.oModelItemDetails.getData().regionText=b;}A.setSalutationTexts(this.oParentController);};A.textRegionReadFailure=function(){A.setSalutationTexts(this.oParentController);};A.setSalutationTexts=function(P){var o=P.getView().byId("smartForm1").getBindingContext().getObject();var s='/SalutationTitleSet';var m=P.getAppModel();m.read(s,{urlParameters:{"$filter":"Title eq '"+o.FormOfAddress+"'"},success:jQuery.proxy(A.saluReadSuccess,this),error:jQuery.proxy(A.saluReadFailure,this)});};A.saluReadSuccess=function(d){if(d.results.length){var s=d.results[0];var b=s.TitleMedi;this.oModelItemDetails.getData().salutationName=b;}A.setSectionsData(this.oModelItemDetails);this.dialog.open();};A.saluReadFailure=function(){A.setSectionsData(this.oModelItemDetails);this.dialog.open();};A.createItemModel=function(P){var o=P.getView().byId("smartForm1").getBindingContext().getObject();this.oModelItemDetails=new sap.ui.model.json.JSONModel(o);return this.oModelItemDetails;};A.setSectionsData=function(m){var L=sap.ui.getCore().byId("selectedItemsSections");L.setModel(m);};A.onCancelChanges=function(){var l=sap.ui.getCore().byId("selectedItemsSections").getItems();var b=sap.ui.getCore().byId("otherItemsList").getItems();for(var i=0;i<l.length;i++){l[i].setSelected(false);}for(var i=0;i<b.length;i++){b[i].setSelected(false);}this.dialog.close();sap.ui.getCore().byId("selSectionsToolbar").setVisible(false);sap.ui.getCore().byId("selItemsToolbar").setVisible(false);sap.ui.getCore().byId("onSelectBtnPG1").setEnabled(false);sap.ui.getCore().byId("onSelectBtnPG2").setEnabled(false);A.goBacktoSectionsPage();};A.onSelectItems=function(p,H,P){sap.ui.getCore().byId("otherItemsList").setModel(P.oItemsList,"b");this.navCon=sap.ui.getCore().byId("Dialog_Nc_ApplyChange");this.navCon.to("p2");};A.goBacktoSectionsPage=function(){sap.ui.getCore().byId("searchinput").setValue(" ");sap.ui.getCore().byId("Dialog_Nc_ApplyChange").to("p1");};A.onUpdateSelectedItemsCount=function(e){var l=e.getSource();var c=l.getSelectedItems();var s=(c&&c.length>0);var L;var i;var b;if(e.getParameter("id")==="selectedItemsSections"){L=sap.ui.getCore().byId("selChangesPage1");i=sap.ui.getCore().byId("selSectionsToolbar");b=sap.ui.getCore().byId("onSelectBtnPG1");}else{L=sap.ui.getCore().byId("selChangesPage2");i=sap.ui.getCore().byId("selItemsToolbar");b=sap.ui.getCore().byId("onSelectBtnPG2");}var t=(s)?c.length+" selected":null;if(s){b.setEnabled(true);}else{b.setEnabled(false);}i.setVisible(s);L.setText(t);};A.getSmartfields=function(P,s){var d=P.getView().byId(s).getModel().getData("/"+P.itemPath);var b=P.getView().byId(s).getSmartFields();return b;};A.preparecopySelectedData=function(b,s,c){for(var i=0;i<s.length;i++){var k=s[i].getDataProperty().typePath;var v=s[i].getValue();var o=this.fieldsForCopy;if(c.indexOf(k)!=-1){if(k==="DeliveryDate"){o[k]=b.DeliveryDate;}else{o[k]=v;}}}};A.belongstoStandard=function(p){var f=["PurchaseRequisitionPrice","MaterialGroup","NetPriceQuantity","AccountAssignmentCategory","Plant","CompanyCode","PurchasingOrganization","PurchasingGroup","ServicePerformer","DeliveryDate","RequestedQuantity","Material","PurchaseRequisitionItemText","FormOfAddress","FullName","PhoneNumber1","FaxNumber","EmailAddress","AddressStreetName","AddressHouseNumber","AddressCityName","AddressPostalCode","AddressCountry","AddressRegion"];if(f.find(p)==undefined){return false;}else{return true;}};A.getExtensibilityfields=function(I,s){var e={};var b=I.getView().byId(s).getSmartFields();for(var j=0;j<b.length;j++){var c=b[j].getBindingInfo("text");for(var p=0;p<c.parts.length;p++){var d=c.parts[p].path;d=d.slice(1,d.length);if(!this.belongstoStandard(d)){e.push(d);}}}return e;};A.onSaveChanges=function(P){this.fieldsForCopy={};var o={};var f=this.fieldsForCopy;var b=this.oModelItemDetails.getData();var s=[];var c=[];var d={};var g={};var h=sap.ui.getCore().byId("selectedItemsSections");var m=h.getSelectedItems();for(var i=0;i<m.length;i++){var n=h.indexOfItem(m[i]);if(n===0){s=A.getSmartfields(P,"smartForm1");try{d=A.getExtensibilityfields(P,"smartForm1");}catch(e){}var q=sap.ui.getCore().byId("generalDataSection").getControlsByFieldGroupId("generalData");for(var j=0;j<q.length;j++){var r=q[j].getBindingInfo("text");for(var p=0;p<r.parts.length;p++){var t=r.parts[p].path;t=t.slice(1,t.length);c.push(t);}}try{for(var e=0;e<d.length;e++){c.push(d[e]);}}catch(e){}if(b.ProductType==="2"){this.fieldsForCopy.PerformancePeriodStartDate=b.PerformancePeriodStartDate;this.fieldsForCopy.PerformancePeriodEndDate=b.PerformancePeriodEndDate;}}if(n===1){s=A.getSmartfields(P,"smartForm2");try{g=A.getExtensibilityfields(P,"smartForm2");}catch(e){}var u=sap.ui.getCore().byId("Applychangedeliveryaddress").getControlsByFieldGroupId("delvAddress");for(var k=0;k<u.length;k++){var r=u[k].getBindingInfo("text");for(var l=0;l<r.parts.length;l++){var t=r.parts[l].path;t=t.slice(1,t.length);c.push(t);}}this.fieldsForCopy.AddressCountry=b.AddressCountry;this.fieldsForCopy.FormOfAddress=b.FormOfAddress;this.fieldsForCopy.AddressRegion=b.AddressRegion;try{for(var e=0;e<g.length;e++){c.push(g[e]);}}catch(e){}}if(n===2){if(b.Supplier!=""){this.fieldsForCopy.Supplier=b.Supplier;}else if(b.FixedSupplier!=""){this.fieldsForCopy.FixedSupplier=b.FixedSupplier;}}if(n!=2){A.preparecopySelectedData(b,s,c);}}var L=sap.ui.getCore().byId("otherItemsList");var S=L.getSelectedItems();for(var j=0;j<S.length;j++){var v=L.getSelectedContexts()[j].getModel().getData().items[j];A.copyToItem(P,this.fieldsForCopy,v.DraftUUID,v.PurchaseRequisitionItem,v.PurchaseRequisition);}P.onPressSave();this.dialog.close();A.onCancelChanges();};A.copyToItem=function(P,f,i,b,p){a.updateItemDetails(P.getServiceCallParameter(A.successItemCopy,A.itemCopyFail),i,p,f,b);};A.successItemCopy=function(){sap.m.MessageToast.show(this.getResourceBundle().getText("sucessMessageApplyChange"));window.history.go(-1);};A.itemCopyFail=function(d){sap.m.MessageToast.show(this.getResourceBundle().getText("failMessageApplyChange"));window.history.go(-1);};A.onSearchMassChange=function(e){var f=[];var q=e.getSource().getValue();if(q&&q.length>0){var b=new F("PurchaseRequisitionItemText",sap.ui.model.FilterOperator.Contains,q);f.push(b);}var l=sap.ui.getCore().byId("otherItemsList");var c=l.getBinding("items");c.filter(f,"Application");};return A;});
