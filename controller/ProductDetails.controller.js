/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ca.ui.message.message");sap.ui.define(["ui/s2p/mm/requisition/maintain/s1/controller/BaseController",'sap/m/MessageBox'],function(B,M){"use strict";return B.extend("ui.s2p.mm.requisition.maintain.s1.controller.ProductDetails",{onInit:function(){this._oRouter=this.getRouter();this._oRouter.getRoute("ProductDetails").attachPatternMatched(this.loadData,this);},loadData:function(e){var p=window.location;window.decodeURIComponent(p);p+='';var s=p.split('searchTerm=');if(p.search("searchTerm")>0){var a="ProductDescription eq '"+s[1]+"'";var m=this.getServiceCallParameter(this.onSuccessSearchBinding,this.serviceFail);this.dataManager.searchResultsBinding(m,a);}this.oModel=this.getAppModel();this.setSourcePage("ProductDetails");this.itemKey=e.getParameter("arguments").OpnCtlgItemID;this.lang=e.getParameter("arguments").Language;if(this.getTestMode()){this.lang="EN";}var v=e.getParameter("arguments").view;var i=e.getParameter("arguments").free;this.isprcscl=e.getParameter("arguments").isprcscl;var b=this.itemKey;if(v==="search"){this.getView().byId("idAddToCart").setVisible(true);}var c="/"+this.entityConstants.getEntityName('productEntity')+"(OpnCtlgItemID="+b+",Language='"+this.lang+"')";var d=this.entityConstants.getEntityName('productEntity')+"(OpnCtlgItemID="+b+",Language='"+this.lang+"')";var f="OpnCtlgItemID eq "+b;var l=" and Language eq '"+this.lang+"'";this.getView().setBusyIndicatorDelay(0);this.getView().setBusy(true);this.getView().byId("iconTabbar").setVisible(false);this.getView().byId("page").bindElement(c);this.setHeaderDraftKey(e.getParameter("arguments").DraftKey);this.setPurchaseRequisition(e.getParameter("arguments").PurchaseRequisition);var P=this.getServiceCallParameter(this.headerSuccess,this.serviceFail);this.dataManager.getHeader(P,this.getHeaderDraftKey(),this.getPurchaseRequisition());var g=this.getView().byId("carousel").getBinding("pages");var h=[];var o=[];o.push(new sap.ui.model.Filter("OpnCtlgAttachmentType",sap.ui.model.FilterOperator.EQ,"03"));o.push(new sap.ui.model.Filter("OpnCtlgAttachmentType",sap.ui.model.FilterOperator.EQ,"01"));h.push(new sap.ui.model.Filter(o,false));h.push(new sap.ui.model.Filter("OpnCtlgItemID",sap.ui.model.FilterOperator.EQ,b));g.filter(h);var t=this.getView().byId("idReviewTable").getBinding("items");var j=[];j.push(new sap.ui.model.Filter("OpnCtlgItemID","EQ",b));t.filter(j);if(p.search("searchTerm")<0&&this.getView().byId("idHeader").getBindingContext()){this.curr=this.getView().byId("idHeader").getBindingContext().getObject().OpnCtlgItemCurrency;}var k=this.getServiceCallParameter(this.fnSetAttrData,this.serviceFail);this.dataManager.getAttributeDetails(k,f,l);this.decimal=this.oModel.oData[d].Decimals;this.prcsclPresent();},onSuccessSearchBinding:function(d){var i=this.itemKey;var a="/"+this.entityConstants.getEntityName('productEntity')+"(OpnCtlgItemID="+i+",Language='"+this.lang+"')";this.getView().byId("page").bindElement(a);},successPrcScale:function(d){var j=new sap.ui.model.json.JSONModel(d);var l=j.oData.results.length;var i=0;for(i=0;i<l;i++){j.oData.results[i].Currency=this.curr;j.oData.results[i].OpnCtlgItemPrice=parseFloat(j.oData.results[i].OpnCtlgItemPrice).toFixed(this.decimal);}this.getView().byId("idPrcSclTable").setModel(j);this.getView().byId("idPrcSclTable").bindElement("/results");var g=this.getView().byId("page");var a=g.getBindingContext().oModel.oData;var b=this.itemKey;var c=this.lang;var e=a["C_Procurementitems(OpnCtlgItemID="+b+",Language='"+this.lang+"')"];var q=this.getResourceBundle().getText("price")+" "+this.getResourceBundle().getText("CurrencyPer")+" "+e.NetPriceQuantity+" "+e.UnitOfMeasure;this.getView().byId("idPrcSclTable").getAggregation("columns")[1].getAggregation("header").setText(q);},prcsclPresent:function(){var i="OpnCtlgItemID eq "+this.itemKey;var m=this.getServiceCallParameter(this.successPrcScalePresent,this.serviceFail);this.dataManager.priceScalefind(m,i);},successPrcScalePresent:function(d){if(d.results.length){this.getView().byId("prcscltab").setVisible(true);this.successPrcScale(d);}else{this.getView().byId("prcscltab").setVisible(false);}},hideTabs:function(){var s=this.getView().byId("sustainability").getText();var d=this.getView().byId("directEms").getText();var i=this.getView().byId("indirectEms").getText();var t=this.getView().byId("tempEms").getText();var r=this.getView().byId("recycleContent").getText();var w=this.getView().byId("waterUsage").getText();var e=this.getView().byId("energyUsage").getText();var a=this.getView().byId("waste").getText();if((s===""||s==="0")&&(d===""||d==="0")&&(i===""||i==="0")&&(t===""||t==="0")&&(r===""||r==="0")&&(w===""||w==="0")&&(e===""||e==="0")&&(a===""||a==="0")){this.getView().byId("sustainabilityTab").setVisible(false);}},fnSetAttrData:function(d){var a=[];for(var i=0;i<d.results.length;i++){a[i]="\n"+d.results[i].OpnCtlgAttribName+": "+d.results[i].OpnCtlgAttribValue+" "+d.results[i].OpnCtlgAttribUnit;}if(a.length>0){this.getView().byId("idAttribute").setText(a);}else{this.getView().byId("technicalDetails").setVisible(false);}this.hideTabs();this.getView().byId("iconTabbar").setVisible(true);this.getView().setBusy(false);},onBack:function(){window.history.back();if(this.reviewDialog){this.reviewDialog.destroy();this.reviewDialog.destroyContent();this.reviewDialog=null;}if(this._oMiniCart){this._oMiniCart.destroy();this._oMiniCart=null;}},handleViewCartPress:function(){var p=this.getPurchaseRequisition()?this.getPurchaseRequisition():this.dataManager.EntityConstants.DUMMY_PR_KEY;this.getRouter().navTo("CartOverview",{DraftKey:this.getHeaderDraftKey(),PurchaseRequisition:p});if(this._oMiniCart){this._oMiniCart.destroy();this._oMiniCart=null;}},onAddReview:function(){if(!this.reviewDialog){this.reviewDialog=sap.ui.xmlfragment("ui.s2p.mm.requisition.maintain.s1.view.AddReview",this);this.getView().addDependent(this.reviewDialog);}this.reviewDialog.open();},onSortReview:function(){var t=this.getView().byId("idReviewTable").getBinding("items");var d;var s=[];if(t.aSorters.bDescending||t.aSorters.length>0){if(t.aSorters[0].bDescending){d=false;}else{d=true;}}else{d=true;}s.push(new sap.ui.model.Sorter("UsageRating",d));t.sort(s);},handleClose:function(){this.reviewDialog.close();},addToCart:function(){var d={RequestedQuantity:"1",DraftUUID:this.getHeaderDraftKey(),PurReqnSSPCrossCatalogItem:Number(this.itemKey)};var p=this.getServiceCallParameter(this.successAddToCart,this.serviceFail);this.dataManager.addToCart(p,d,this.getHeaderDraftKey());this.getView().setBusy(true);},submitReview:function(){var p=sap.ui.getCore().byId("idProductRating").getProperty("value");var c=sap.ui.getCore().byId("idReviewText").getProperty("value");var i=this.itemKey;var d=this.getView().byId("productDetails").getBindingContext();var E="";var C="";var D={};this.reviewDialog.close();if(d){E=d.getProperty("OpnCtlgExternalProductID");C=d.getProperty("OpnCtlgWebServiceID");D={OpnCtlgItemID:Number(i),OpnCtlgExternalProductID:E,OpnCtlgWebServiceID:C,UsageRating:Number(p).toFixed(2),ReviewedByUser:c,ChangedDateTime:""};}if(i.length>0&&E!==""&&C!==""){if(Number(p)>0){var P=this.getServiceCallParameter(this.fnSuccessAddReview,this.fnReviewFailed);this.dataManager.submitReview(P,D);}else{sap.m.MessageToast.show(this.getResourceBundle().getText("RatingNeeded"));this.reviewDialog.open();}}else{this.fnReviewFailed();}},fnSuccessAddReview:function(){this.getView().setBusy(false);sap.m.MessageToast.show(this.getResourceBundle().getText("ReviewSuccess"));var t=this.getView().byId("idReviewTable").getBinding("items");t.refresh();var r=this.getView().byId("idReviewTable").getItems();var o=this.getView().byId("rating").getProperty("value");var n=sap.ui.getCore().byId("idProductRating").getProperty("value");var a=parseFloat((o*r.length+n)/(r.length+1));this.getView().byId("rating").setValue(a);},onUpdateFinished:function(){var u=this.getView().byId("idReviewTable").getItems();if(u.length>0&&u[0].getBindingContext().getProperty("UserID")===this.getUserID()){this.getView().byId("btnAddReview").setEnabled(false);}else{this.getView().byId("btnAddReview").setEnabled(true);}this.getView().byId("reviewCount").setText("("+u.length+")");this.checkError();},checkError:function(){var t=this;var a;var m=sap.ui.getCore().getMessageManager();var o=m.getMessageModel();var b=o.aBindings[1].oValue[0].code;if(b=='MMPUR_REQ_COMMON/023'){var a=o.aBindings[1].oValue[0].message;this.getView("ProductDetails").destroyContent();M.show(a,{icon:M.Icon.ERROR,title:t.getResourceBundle().getText("ProductDetails"),actions:[t.getResourceBundle().getText("ok")],onClose:function(A){if(A===t.getResourceBundle().getText("ok")){window.history.back();}},initialFocus:t.getResourceBundle().getText("ok")});}},fnReviewFailed:function(){this.getView().setBusy(false);sap.m.MessageToast.show(this.getResourceBundle().getText("ReviewFailed"));},successAddToCart:function(){this.updateHeader();this.getView().setBusy(false);sap.m.MessageToast.show(this.getResourceBundle().getText("AddToCart"));},updateHeader:function(){var p=this.getServiceCallParameter(this.updateHeaderSuccess,this.serviceFail);this.dataManager.getHeader(p,this.getHeaderDraftKey(),this.getPurchaseRequisition());},updateHeaderSuccess:function(){this.dataManager.updateHeaderSuccess(this.getView().byId('btnCart'),[this.getPurchaseRequisition(),"guid'"+this.getHeaderDraftKey()+"'"]);var t=this;setTimeout(function(){t.firstMiniCartOpen();},2000);},handlePopoverPress:function(e){if(!this._oPopover){this._oPopover=sap.ui.xmlfragment("ui.s2p.mm.requisition.maintain.s1.fragment.PopOver",this);this.getView().addDependent(this._oPopover);}var b=e.getSource();jQuery.sap.delayedCall(0,this,function(){this._oPopover.openBy(b);});},sendEmail:function(){var u=window.location;u+="&searchTerm="+this.getView().byId("idHeader").getTitle();window.encodeURIComponent(u);var e=this.getResourceBundle().getText("emailsubject")+":"+this.getView().byId("idHeader").getTitle();sap.m.URLHelper.triggerEmail("",e,u);}});});
