/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["ui/s2p/mm/requisition/maintain/s1/controller/BaseController","sap/ui/model/json/JSONModel",'sap/m/MessageToast','sap/m/MessageBox',"ui/s2p/mm/requisition/maintain/s1/model/formatter"],function(B,J,f,M){"use strict";return B.extend("ui.s2p.mm.requisition.maintain.s1.controller.PurReqList",{onInit:function(){this.getView().setVisible(false);this.oModel=this.getAppModel();this._oView=this.getView();this._oComponent=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this._oView));this._oRouter=this._oComponent.getRouter();this._oRouter.getRoute("PurReqList").attachPatternMatched(this._onObjectMatched,this);},_onObjectMatched:function(){if(this.getOwnerComponent().getComponentData().changingSourcePageAllowed){this.setSourcePage("PurReqList");}if((this.getPurchaseRequisition()==="")||(this.getSourcePage()==="PurReqList")){this.getView().setVisible(true);this.getView().getModel().refresh();}else{if(this.getSourcePage()==""){this.setSourcePage("CartOverview");}if(!(this.getSourcePage()==="PurReqList")){this.navToSourcePage();}}},onNavBack:function(){var c=sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"#"}});},fnNavigateItemList:function(e){if(this._oHistory){this._oHistory.destroy();}this.setLifeCycleStatus(e.getSource().getBindingContext());var p=e.getSource().getBindingContext().getProperty("PurchaseRequisition");this.setPurchaseRequisition(p);this.checkDraft(p);},fnNavigateEditItemList:function(e){var p=this.getView().byId("idRequisitionItemsTable").getSelectedItem().getBindingContext().getObject().PurchaseRequisition;this.setPurchaseRequisition(p);this.checkDraft(p);},fnNavigateReturnGR:function(e){if(this.getView().byId("idRequisitionItemsTable").getSelectedItem()){var p=this.getView().byId("idRequisitionItemsTable").getSelectedItem().getBindingContext().getObject().PurchaseRequisition;var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"GoodsReceipt",action:"return"},params:{PurchaseRequisition:[p]}});}else{M.error("Select a PR for return");}},fnNavigateConfirmGR:function(e){if(this.getView().byId("idRequisitionItemsTable").getSelectedItem()){var p=this.getView().byId("idRequisitionItemsTable").getSelectedItem().getBindingContext().getObject().PurchaseRequisition;var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"GoodsReceipt",action:"create"},params:{PurchaseRequisition:[p]}});}else{M.error("Select an item to confirm");}},checkDraft:function(p){this.dataManager.getCurrentDraft(this.getServiceCallParameter(this.saveDraftUID,this.serviceFail),p);},saveDraftUID:function(d){var t=this;var p=d.results?d.results[0]:d;var a=this.getDraftKey(p,true);if(a){M.show(this.getResourceBundle().getText("draftMessage"),{icon:M.Icon.INFORMATION,title:t.getResourceBundle().getText("draft"),actions:[t.getResourceBundle().getText("continue"),t.getResourceBundle().getText("discard")],onClose:function(A){if(A===t.getResourceBundle().getText("continue")){t.getRouter().navTo("CartOverview",{DraftKey:a,PurchaseRequisition:p.PurchaseRequisition});}else{t.deleteDraft(a);}},initialFocus:t.getResourceBundle().getText("continue")});}else{this.editDraft();}},deleteDraft:function(d){this.dataManager.deleteDraft(this.getServiceCallParameter(this.editDraft,this.serviceFail),d,this.getPurchaseRequisition());},editDraft:function(){var d='00000000-0000-0000-0000-000000000000';this.dataManager.editDocument(this.getServiceCallParameter(this.getDraftId,this.errorServiceFail),d,this.getPurchaseRequisition());},getDraftId:function(d){var p=d.results?d.results[0]:d;var a=this.getDraftKey(p,true);this.setHeaderDraftKey(a);this.setUserID(p.Employee);this.getRouter().navTo("CartOverview",{DraftKey:this.getHeaderDraftKey(),PurchaseRequisition:this.getPurchaseRequisition()});},checkDelete:function(d){var t=this;d.Delete_mc=true;this.getView().setBusy(false);if(d.Delete_mc){var P=this.getView().byId("idRequisitionItemsTable").getSelectedItem().getBindingContext().getObject().PurchaseRequisition;M.show(this.getResourceBundle().getText("deleteCart"),{icon:M.Icon.INFORMATION,title:t.getResourceBundle().getText("overviewDelete"),actions:[t.getResourceBundle().getText("continue"),t.getResourceBundle().getText("cancel")],onClose:function(a){if(a===t.getResourceBundle().getText("continue")){t.onDeletePurReq(P);}},initialFocus:t.getResourceBundle().getText("continue")});}else{M.show(this.getResourceBundle().getText("deleteFailed"),{icon:M.Icon.INFORMATION,title:t.getResourceBundle().getText("overviewDelete"),actions:[t.getResourceBundle().getText("ok")],onClose:function(a){if(a===t.getResourceBundle().getText("ok")){}},initialFocus:t.getResourceBundle().getText("ok")});}},onPressDeleteRequisition:function(){if(this.getView().byId("idRequisitionItemsTable").getSelectedItem()){this.getView().setBusy(true);this.dataManager.getHeader(this.getServiceCallParameter(this.checkDelete,this.serviceFail),"00000000-0000-0000-0000-000000000000",this.getView().byId("idRequisitionItemsTable").getSelectedItem().getBindingContext().getObject().PurchaseRequisition,true);}else{M.error("Select an item to delete");}},onDeletePurReq:function(P){var u="/sap/opu/odata/sap/MMPUR_REQ_SSP_MAINTAIN_SRV/";var v=[P,"guid'00000000-0000-0000-0000-000000000000'",true];var k=this.entityConstants.getKeys("headerEntity");var a={};for(var j=0;j<k.length;j++){a[k[j]]=v[j];}var b="";b=b+k[0]+"='"+a[k[0]]+"'";for(var i=1;i<k.length;i++){b=b+",";if(typeof a[k[i]]!=="boolean"){if(a[k[i]].startsWith("guid")){b=b+k[i]+"="+a[k[i]];}else{if(a[k[i]]==="false"){a[k[i]]=false;b=b+k[i]+"="+a[k[i]];}else{b=b+k[i]+"='"+a[k[i]]+"'";}}}else{b=b+k[i]+"="+a[k[i]];}}var U=this.entityConstants.getEntityName('headerEntity')+"("+b+")";var m=new sap.ui.model.odata.ODataModel(u);m.remove(U,{batchGroupId:1,changeSetId:1,success:jQuery.proxy(this.onSuccessDelete,this),error:jQuery.proxy(this.onErrorDelete,this)});},onPressCreate:function(){sap.m.MessageToast.show(this.getResourceBundle().getText("delete"));if(this.itemCount===1){this.getRouter().navTo("Search");}else{window.history.back();}},onErrorDelete:function(e){var E=e.response.body.split("<message>")[1].split("</message>")[0];sap.m.MessageToast.show(E,{duration:2000});this.getView().byId("idSmartTablePRList").getModel().refresh();this.byId("deleteReqLinkId").setEnabled(false);},onSuccessDelete:function(){var s=this.getOwnerComponent().getModel("i18n").getResourceBundle().getText("MSG_SUCCESS_DELETE");sap.m.MessageToast.show(s,{duration:2000});this.getView().byId("idSmartTablePRList").getModel().refresh();this.byId("deleteReqLinkId").setEnabled(false);},handlePRFactSheetNavigation:function(e){var s=e.getSource().getBindingContext().getObject();var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"PurchaseRequisition",action:"displayFactSheet"},params:{PurchaseRequisition:[s.PurchaseRequisition]}});},onSearchPRList:function(){var t=this.getView().byId("idSmartTablePRList");var b=t.getTable().getBinding("items");var s=this.byId("idSmartFilterPRList");var S=s.getFilters();var p=s.getParameters();b.sCustomParams=b.getModel().createCustomParams({custom:{search:p.custom.search}});var F=sap.ui.core.format.DateFormat.getDateInstance({pattern:"yyyy-MM-dd"});var a=F.format(this.byId("timeRangeFilter").getDateValue(),false);var c=F.format(this.byId("timeRangeFilter").getSecondDateValue(),false);if(a!==null&&c!==null&&a!==""&&c!==""){var o=new sap.ui.model.Filter("CreationDate",sap.ui.model.FilterOperator.BT,a,c);S.push(o);}b.filter(S,p);},checkDateNow:function(e){var v=e.getParameter("valid");var d=e.getSource();if(v){d.setValueState(sap.ui.core.ValueState.None);}else{d.setValueState(sap.ui.core.ValueState.Error);d.setValueStateText(this.getResourceBundle().getText("dateRangeError"));}},onPressRow:function(){if(this.getView().byId("idRequisitionItemsTable").getSelectedItem()){var p=this.getView().byId("idRequisitionItemsTable").getSelectedItem().getBindingContext().getObject().PurReqnLifeCycleStatus;var s=this;var m;var t=this.getView().byId("idRequisitionItemsTable");var i=t.getSelectedContexts()[0].getObject().IsExtPurgScenario;var P=t.getSelectedContexts()[0].getObject().PurchaseRequisition;if(i==='X'||i!=""){m=s.getView().getModel();var a={method:"GET",urlParameters:{PRNumber:P},success:function(d,r){if(r.statusText==='OK'){if(d.GRFlag===true){s.byId("ConfirmGRLinkId").setEnabled(true);s.byId("deleteReqLinkId").setEnabled(false);}else{s.byId("ConfirmGRLinkId").setEnabled(false);}if(d.RTDFlag===true){s.byId("ReturnGRLinkId").setEnabled(true);s.byId("deleteReqLinkId").setEnabled(false);}else{s.byId("ReturnGRLinkId").setEnabled(false);}}},error:function(e){var l=e;}};m.callFunction("/CheckGREnabled",a);}else{if(p!=='X'){this.byId("deleteReqLinkId").setEnabled(true);}else{this.byId("deleteReqLinkId").setEnabled(false);}if(p==='G'){this.byId("ReturnGRLinkId").setEnabled(true);this.byId("deleteReqLinkId").setEnabled(false);}else{this.byId("ReturnGRLinkId").setEnabled(false);}if(p==='C'){this.byId("ConfirmGRLinkId").setEnabled(true);this.byId("deleteReqLinkId").setEnabled(false);}else{this.byId("ConfirmGRLinkId").setEnabled(false);}if(p==='P'){this.byId("ConfirmGRLinkId").setEnabled(true);this.byId("ReturnGRLinkId").setEnabled(true);this.byId("deleteReqLinkId").setEnabled(false);}if(p==='B'){this.byId("deleteReqLinkId").setEnabled(false);}}}},handleStatusPress:function(e){var t=this;var i;this.getView().byId("page").setBusy(true);this.oButton=e.getSource();this.PRNumber=e.getSource().getBindingContext().getObject().PurchaseRequisition;this.PurReqnLifeCycleStatus=e.getSource().getBindingContext().getObject().PurReqnLifeCycleStatus;i=e.getSource().getBindingContext().getObject().IsExtPurgScenario;this.setExtScenarioFlag(i);var m=t.getAppModel();if(this.PRNumber){m.read("/C_Sspprmaint_Hdr",{urlParameters:{"$filter":"IsActiveEntity eq true and PurchaseRequisition eq '"+this.PRNumber+"'","$expand":"to_Purchaserequisitionitem_Wd"},success:jQuery.proxy(this.itemssSuccessHandler,this),error:jQuery.proxy(this.statusErrorHandler,this)});}},itemssSuccessHandler:function(d){var D=d.results[0].to_Purchaserequisitionitem_Wd;this.oModelPf2=new sap.ui.model.json.JSONModel();var n=sap.ui.getCore().byId("navCon");if(n){n.to("p1");}this.oModelPf2.setData(D);if(!this._oHistory){this._oHistory=sap.ui.xmlfragment("ui.s2p.mm.requisition.maintain.s1.fragment.PRHistory",this);this.getView().addDependent(this._oHistory);}sap.ui.getCore().byId("itemsList").setModel(this.oModelPf2,"pf2");this.getView().byId("page").setBusy(false);this._oHistory.getContent()[0].getPages()[0].getSubHeader().getContent()[0].setValue("");this._oHistory.openBy(this.oButton);},handleNav:function(e){var n=sap.ui.getCore().byId("navCon");var s=e.getSource().getBindingContext("pf2").getObject().PurReqnItemLifeCycleStatus;if(s==="B"||s==="A"||s==="K"||s==="L"||s==="R"||s==="S"||s==="02"||s==="05"){this.PRItemNumber=e.getSource().getBindingContext("pf2").getObject().PurchaseRequisitionItem;this.itemText=e.getSource().getTitle();this.statusFromMYPR_DBind(this.PRNumber,this.PRItemNumber,n);}else{sap.m.MessageToast.show(this.getResourceBundle().getText("noFollowOnDoc"));}},goBack:function(){var n=sap.ui.getCore().byId("navCon");n.back();},showStatus:function(e){this.getView().setBusy(true);var p=this.PRNumber;while(p.length<10){p="0"+p;}var a=e.getSource().getBindingContext().getObject().PurchaseRequisitionItem;if(!this._historyDialog){this.statusData(p,a);}else{this._historyDialog.open();this.getView().setBusy(false);}},onItemSearch:function(e){var F=[];var q=e.getSource().getValue();if(q&&q.length>0){var a=new sap.ui.model.Filter("PurchaseRequisitionItemText",sap.ui.model.FilterOperator.Contains,q);F.push(a);}var l=sap.ui.getCore().byId("itemsList");var b=l.getBinding("items");b.filter(F);},cancelFilter:function(e){e.getSource().reset();},ResetFields:function(e){this.byId("timeRangeFilter").setValue("");},onBeforeExport:function(e){var E=e.getParameter("exportSettings");if(E.url){return;}if(E.workbook&&E.workbook.columns){E.workbook.columns.forEach(function(c){if(c.columnId&&c.columnId.indexOf("idStatusColumn")>-1){c.property="PurReqnLifeCycleStatusName";c.type="string";return true;}});}}});});
