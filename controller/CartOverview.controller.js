/*
 * Copyright (C) 2009-2019 SAP SE or an SAP affiliate company. All rights reserved.
 */
jQuery.sap.require("sap.ui.core.mvc.Controller");jQuery.sap.require("sap.m.TablePersoController");jQuery.sap.require("sap.ui.core.message.MessageManager");jQuery.sap.require("sap.ca.ui.message.message");sap.ui.define(["ui/s2p/mm/requisition/maintain/s1/controller/BaseController","sap/ui/model/json/JSONModel","ui/s2p/mm/requisition/maintain/s1/model/formatter",'sap/m/MessageToast','sap/m/MessageBox',"sap/ui/Device"],function(B,J,f,M,a,D){"use strict";return B.extend("ui.s2p.mm.requisition.maintain.s1.controller.CartOverview",{formatter:f,onInit:function(){var v=new sap.ui.model.json.JSONModel();var m={editable:false};if(this.getMode()==="edit"){v.setData(m);this.getView().setModel(v,"viewProperties");this.getView().byId("columnListItem").setModel(v,"viewProperties");}else{m={editable:true};v.setData(m);this.getView().setModel(v,"viewProperties");this.getView().byId("columnListItem").setModel(v,"viewProperties");}this.oModel=this.getAppModel();this._oView=this.getView();this._oComponent=sap.ui.component(sap.ui.core.Component.getOwnerIdFor(this._oView));this.getRouter().getRoute("CartOverview").attachPatternMatched(this._handleRouteMatched,this);this._oCartTable=this.byId("productsTable");this._oItemTemplate=this.byId("columnListItem").clone();this.firstTime=true;},_handleRouteMatched:function(e){if(this.getOwnerComponent().getComponentData().changingSourcePageAllowed){this.setSourcePage("CartOverview");}this.getView().setBusyIndicatorDelay(0);this.getView().setBusy(true);this.setHeaderDraftKey(e.getParameter("arguments").DraftKey);this.setPurchaseRequisition(e.getParameter("arguments").PurchaseRequisition);this.currentPRNumber=this.getPurchaseRequisition();if(this.getTestMode()){this.genInfoCart();}else{var p=this.getServiceCallParameter(this.genInfoCart,this.errorServiceFail);this.dataManager.getHeader(p,this.getHeaderDraftKey(),this.getPurchaseRequisition());}},onUpdateFinished:function(){var e=!this._hasInvalidQuantityValues();this.byId("btnCheckOut").setEnabled(e);this.byId("btnDeleteCart").setEnabled(e);var b=this.getView().byId("productsTable").getItems();this.styleClass=this._oComponent.getContentDensityClass();for(var i=0;i<b.length;i++){var C=this.getView().byId("productsTable").getItems()[i].getBindingContext().getObject().OpnCtlgHasPriceScale;if(C=='X'){b[i].getAggregation("cells")[3].getAggregation("items")[1].setVisible(true);}else{b[i].getAggregation("cells")[3].getAggregation("items")[1].setVisible(false);}if(!b[i].getBindingContext().getProperty("PurReqnSSPCrossCatalogItem")){b[i].getAggregation("cells")[1].getAggregation("items")[0].setEnabled(false);}if(this.styleClass==="sapUiSizeCozy"){b[i].getAggregation("cells")[0].removeStyleClass("sapUiSmallMarginTopBottom");}if(this.getPurchaseRequisition()&&b[i].getAggregation("cells")[3].getAggregation("items")[0].getEditable()){this.getView().byId("btnCheckOut").setEnabled(true);}if(this.getPurchaseRequisition()){var c=this.getView().byId("productsTable").getItems()[i].getBindingContext().getObject().PurchaseRequisitionItem;this.ItemStatus=this.getLifeCycleStatus(c);if(this.ItemStatus==="B"||this.ItemStatus==="A"||this.ItemStatus==="K"||this.ItemStatus==="L"||this.ItemStatus==="R"||this.ItemStatus==="S"){b[i].getAggregation("cells")[2].getAggregation("items")[0].setVisible(true);this.getView().byId("productsTable").getColumns()[2].getHeader().setVisible(true);}else{b[i].getAggregation("cells")[2].getAggregation("items")[0].setVisible(false);this.getView().byId("productsTable").getColumns()[2].getHeader().setVisible(false);}}}this.totalPriceCart(this.getView().byId("productsTable").getItems());this.updatecartItems(this.getView().byId("productsTable").getItems());if(this.getView().byId("productsTable").getItems().length>0){this.getView().byId('btnCart').setType("Emphasized");}else{this.getView().byId('btnCart').setType("Default");}this.getView().setBusy(false);if(!this.getTestMode()){this.getView().byId("btnDeleteCart").setEnabled(this.getView().getBindingContext().getObject().Delete_ac);this.getView().byId("btnCheckOut").setEnabled(this.getView().getBindingContext().getObject().Delete_ac&&e);}},_hasInvalidQuantityValues:function(){var p=this.getView().byId("productsTable");var q=p.indexOfColumn(this.byId("quantityColumn"));if(q===-1){return false;}var i,I=p.getItems();for(i=0;i<I.length;i++){if(I[i].getAggregation("cells")[q].getAggregation("items")[0].getValueState()==="Error"){return true;}}return false;},cartService:function(){this.dataManager.cartService(this._oCartTable,this._oItemTemplate,[this.getPurchaseRequisition(),"guid'"+this.getHeaderDraftKey()+"'",false]);},genInfoCart:function(d){if(this.currentPRNumber!==""){if(!this.getTestMode()){if(d.PurReqnLifeCycleStatus==="G"){this.getView().byId("btnReturn").setEnabled(true);}else{this.getView().byId("btnReturn").setEnabled(false);}}}if(this.currentPRNumber!==""){if(!this.getTestMode()){if(d.PurReqnLifeCycleStatus==="C"){this.getView().byId("btnConfirm").setEnabled(true);}else{this.getView().byId("btnConfirm").setEnabled(false);}}}this.dataManager.genInfoCartView(this.getView(),[this.getPurchaseRequisition(),"guid'"+this.getHeaderDraftKey()+"'",false]);this.dataManager.genInfoCartButton(this.getView().byId("btnCart"),[this.getPurchaseRequisition(),"guid'"+this.getHeaderDraftKey()+"'",false]);if(!this.getTestMode()){this.getView().getBindingContext().getObject();}this.getView().setBusy(false);if(this.firstTime){this.cartService();this.firstTime=false;}else{this.cartService();this.getView().byId("productsTable").getBinding("items").refresh();}},onCartItemPressed:function(E){this.setItemStatus(this.ItemStatus);this.getOrderDelete();try{var c=E.getSource().getBindingContext().getProperty("PurReqnSSPCrossCatalogItem");}catch(e){c='6334';}try{var b=E.getSource().getBindingContext().getProperty("DraftUUID");var d=E.getSource().getBindingContext().getPath().substr(1);var P=E.getSource().getBindingContext().getProperty("PurchaseRequisitionItem");var g=E.getSource().getAggregation("cells")[3].getAggregation("items")[0].getEditable();}catch(e){b='c23e13de-8504-4180-88ba-d4f664219426';d="C_Sspprmaint_Itm(PurchaseRequisition='PurchaseRequisition%208',PurchaseRequisitionItem='PurchaseRequisitionItem%201',DraftUUID=guid'c23e13de-8504-4180-88ba-d4f664219426',IsActiveEntity=false)";P='PurchaseRequisitionItem 1';g=true;}var p=this.getPurchaseRequisition()?this.getPurchaseRequisition():this.entityConstants.DUMMY_PR_KEY;this.prNumber=p;var m=sap.ui.getCore().getMessageManager();m.removeAllMessages();this.getRouter().navTo("ItemDetails",{DraftKey:this.getHeaderDraftKey(),PurchaseRequisition:p,OpnCtlgItemID:c,DraftUUID:b,items:d,PurchaseRequisitionItem:P,Editable:g});var h=this.getView().byId("productsTable").getItems();var t=[];for(var i=0;i<h.length;i++){var o=h[i].getBindingContext().getObject();t.push(o);}var j=new sap.ui.model.json.JSONModel();j.setData(t);sap.ui.getCore().setModel(j);},onBack:function(){if(this.getPurchaseRequisition()===''){this.setSourcePage('FreeText');}else{this.setSourcePage('PurReqList');}var p=this.getPurchaseRequisition()?this.getPurchaseRequisition():this.entityConstants.DUMMY_PR_KEY;this.prNumber=p;this.setOrderDelete('dontStopNav');window.history.back();if(this._oMiniCart){this._oMiniCart.destroy();this._oMiniCart=null;}},onExit:function(){this.setOrderDelete('dontStopNav');if(this._oMiniCart){this._oMiniCart.destroy();this._oMiniCart=null;}},updatecartItems:function(d){var c=d.length;if(d.length>=1){this.getView().byId("table").setText("Items ("+c+")");}else{this.getView().byId("table").setText("Items ("+c+")");}},totalPriceCart:function(d){var t=0;if(d.length>=1){for(var i=0;i<d.length;i++){t=t+Number(d[i].getBindingContext().getProperty("TotalNetAmount"));}t=t.toFixed(2);}else{}},onPRNameChanged:function(){this.getView().setBusy(true);var p={PurReqnDescription:this.getView().byId("PRName").getValue()};this.dataManager.updateHeader(this.getServiceCallParameter(this.successOnPRNameChanged,this.serviceFail),this.getHeaderDraftKey(),this.getPurchaseRequisition(),p);},successOnPRNameChanged:function(){this.getView().setBusy(false);sap.m.MessageToast.show(this.getResourceBundle().getText("updatePRDesc"));},onQuantityChanged:function(e){var q=e.getSource().getValue();q=q.split('.').join('');q=q.split(',').join('');if(q.length>13||(Number(q)<=0||isNaN(Number(q)))){this.getView().byId(e.getSource().getId()).setValueState(sap.ui.core.ValueState.Error);this.getView().byId(e.getSource().getId()).setValueStateText(this.getResourceBundle().getText("quantityError"));this.getView().byId("productsTable").getModel().refresh(true);}else{e.getSource().setValueState(sap.ui.core.ValueState.None);var b=this.getView().byId("productsTable").getBinding("items");b.attachChange(function(){this.totalPriceCart(this.getView().byId("productsTable").getItems());this.updatecartItems(this.getView().byId("productsTable").getItems());}.bind(this));var d=e.getSource().getBindingContext().getObject().DraftUUID;var i=e.getSource().getBindingContext().getObject().PurchaseRequisitionItem;var o=e.getSource().getBindingContext().getObject();o=this.adjustPayload(o);this.dataManager.updateItemDetails(this.getServiceCallParameter(this.successOnQuantityChanged,this.serviceFail),d,this.getPurchaseRequisition(),o,i);}},successOnQuantityChanged:function(){var m=sap.ui.getCore().getMessageManager();var b=m.getMessageModel().getData();var c=-1;for(var i=0;i<b.length;i++){if(b[i].message&&b[i].code==="MMPUR_REQ_COMMON/022"){sap.m.MessageToast.show(b[i].message);c=1;break;}else{c=0;}}this.getView().byId("productsTable").getModel().refresh(true);this.oModel.refresh(true);if(c!==1){sap.m.MessageToast.show(this.getResourceBundle().getText("update"));}},deleteItemPressed:function(e){var i=e.getParameter('listItem');var l=e.getSource();var t=this;var p;if(this.getTestMode()){p="/C_Sspprmaint_Itm(PurchaseRequisition='PurchaseRequisition 8',PurchaseRequisitionItem='PurchaseRequisitionItem 1',DraftUUID=guid'c23e13de-8504-4180-88ba-d4f664219426',IsActiveEntity=false)";this.deleteSuccess(l,p);}else{this.deleteItemId=e.getParameter('listItem').getId();this.deletable=e.getSource().getBindingContext().getObject().Delete_mc;this.deletable=true;p=i.getBindingContext().getPath();if(this.deletable){var h=parseInt(this.getView().byId("btnCart").getText());if(h===1){if(this.getPurchaseRequisition()===''){sap.m.MessageBox.show(t.getResourceBundle().getText("msgDeleteLastItemCart"),{icon:sap.m.MessageBox.Icon.WARNING,title:t.getResourceBundle().getText("msgBoxTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:"sapUiSizeCompact",onClose:function(A){if(A===sap.m.MessageBox.Action.OK){t.deleteSuccess(l,p);setTimeout(function(){t.getDraftSuccessCallback();},2000);}},initialFocus:sap.m.MessageBox.Action.OK});}else{t.deleteSuccess(l,p);setTimeout(function(){t.getDraftSuccessCallback();},2000);}}else{this.deleteSuccess(l,p);}}else{a.show(this.getResourceBundle().getText("deleteFailed"),{icon:a.Icon.INFORMATION,title:t.getResourceBundle().getText("overviewDelete"),actions:[t.getResourceBundle().getText("ok")],onClose:function(A){if(A===t.getResourceBundle().getText("ok")){}},initialFocus:t.getResourceBundle().getText("ok")});}}},deleteSuccess:function(l,p){var t=this;var b=this.getView().byId("productsTable").getBinding("items");b.attachChange(function(){this.totalPriceCart(this.getView().byId("productsTable").getItems());this.updatecartItems(this.getView().byId("productsTable").getItems());}.bind(this));l.getModel().remove(p);l.attachEventOnce('updateFinished',l.focus,l);this.refreshMinicart();setTimeout(function(){sap.m.MessageToast.show(t.getResourceBundle().getText("delete"));},1000);},handleDeleteCartPress:function(){var t=this;sap.m.MessageBox.show(t.getResourceBundle().getText("msgDiscardCart"),{icon:sap.m.MessageBox.Icon.WARNING,title:t.getResourceBundle().getText("msgBoxTitle"),actions:[sap.m.MessageBox.Action.OK,sap.m.MessageBox.Action.CANCEL],styleClass:"sapUiSizeCompact",onClose:function(A){if(A===sap.m.MessageBox.Action.OK){t.dataManager.deleteDraft(t.getServiceCallParameter(t.onSuccessDeleteHeader,t.serviceFail),t.getHeaderDraftKey(),t.getPurchaseRequisition());t.setOrderDelete(true);t.getView().setBusy(true);if(this._oMiniCart){this._oMiniCart.destroy();this._oMiniCart=null;}}},initialFocus:sap.m.MessageBox.Action.OK});},onSuccessDeleteHeader:function(){sap.m.MessageToast.show(this.getResourceBundle().getText("deleteAll"));if(this.getTestMode()){this.getRouter().navTo("Search");}else{if(this.getPurchaseRequisition()===''){this.getRouter().navTo("Search");}else{this.getRouter().navTo("PurReqList");}}},getDraftSuccessCallback:function(){var t=this;if(this.getPurchaseRequisition()===''){t.getRouter().navTo("Search");}else{sap.m.MessageBox.show(t.getResourceBundle().getText("myPRmsgDeleteLastItemCart"),{icon:sap.m.MessageBox.Icon.WARNING,title:t.getResourceBundle().getText("msgBoxTitle"),actions:[sap.m.MessageBox.Action.OK],styleClass:"sapUiSizeCompact",onClose:function(A){if(A===sap.m.MessageBox.Action.OK){}},initialFocus:sap.m.MessageBox.Action.OK});}},PricescaleClick:function(e){if(!this._prcsclPopover){this._prcsclPopover=sap.ui.xmlfragment("ui.s2p.mm.requisition.maintain.s1.view.PriceRange",this);}var p="OpnCtlgItemID eq "+e.getSource().getParent().getParent().getBindingContext().getObject().PurReqnSSPCrossCatalogItem;var q=e.getSource().getParent().getParent().getBindingContext().getObject().NetPriceQuantity;this.curr=" "+e.getSource().getParent().getParent().getBindingContext().getObject().Currency;var b=e.getSource().getParent().getParent().getBindingContext().getObject().BaseUnit;q=this.getResourceBundle().getText("price")+" "+this.getResourceBundle().getText("CurrencyPer")+" "+q+" "+b;var m=this.getServiceCallParameter(this.successPrcScale,this.serviceFail);this.dataManager.priceScalefind(m,p);this.getView().addDependent(this._prcsclPopover);jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this._prcsclPopover);var P=e.getSource();jQuery.sap.delayedCall(0,this,function(){this._prcsclPopover.openBy(P);});this._prcsclPopover.getAggregation("content")[0].getAggregation("columns")[1].getAggregation("header").setText(q);},successPrcScale:function(d){var j=new sap.ui.model.json.JSONModel(d);var l=j.oData.results.length;var i=0;for(i=0;i<l;i++){j.oData.results[i].Currency=this.curr;}this._prcsclPopover.getContent()[0].setModel(j);this._prcsclPopover.getContent()[0].bindElement("/results");},ViewDetails:function(e){this.setOrderDelete('stopNav');var c=e.getSource().getBindingContext().getObject().PurReqnSSPCrossCatalogItem;var C=sap.ui.getCore().getConfiguration().getLanguage();C=C.substr(0,2).toUpperCase();var i=e.getSource().getBindingContext().getObject().DraftUUID;var p=this.getPurchaseRequisition()?this.getPurchaseRequisition():this.entityConstants.DUMMY_PR_KEY;this.prNumber=p;if(c){this.getRouter().navTo("ProductDetails",{DraftKey:this.getHeaderDraftKey(),PurchaseRequisition:p,view:"cartOverview",OpnCtlgItemID:c,Language:C,free:i});}if(this._oMiniCart){this._oMiniCart.destroy();this._oMiniCart=null;}},handleReturnPress:function(){var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"GoodsReceipt",action:"return"},params:{PurchaseRequisition:[this.currentPRNumber]}});},handleConfirmPress:function(){var c=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");c.toExternal({target:{semanticObject:"GoodsReceipt",action:"create"},params:{PurchaseRequisition:[this.currentPRNumber]}});},showStatus:function(e){this.getView().setBusy(true);this.oButton=e.getSource();var p=e.getSource().getBindingContext().getObject().PurchaseRequisition;var b=e.getSource().getBindingContext().getObject().PurchaseRequisitionItem;this.statusFromCO_Cntrls();this.statusFromCO_DBind(p,b);},adjustPayload:function(d){for(var p in d){if(p.search('_fc')<0){var b=p.toString()+"_fc";if(d[b]===1||d[b]===0){delete d[p];delete d[b];}}}return d;},handleClose:function(){}});});
